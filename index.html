<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,800;0,900;1,900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Document</title>
</head>
<body class="body">
    <div class="header">
        B-Format converter
    </div>
    <div class="grid-container">
        <div class="grid-item left">
            <div id="filename" class="grid-item left-grid">
                No file uploaded
            </div>
            <div class="grid-item left-grid">
                <input type="file" id="upload" />
                <input type="button" value="Upload B-Format file" onclick="document.getElementById('upload').click();" class="btn-big btn btn-info"/>
            </div>
            <div class="grid-item left-grid">
                <p class="text-box">Upload file to server.<br>
                File shouldn't contain more than 5.292.000 samples (30 seconds of 44100 samples/second, 4 channel recording).</br>
                Only accepted format is 16 bit *.wav file.</p>
            </div>
        </div>
        <div class="grid-item right"> 
            <div class="right-grid-1">
                <div class="right-grid-1-item">
                    <p class="right-grid-1-item-label">Choose output channel amount:</p>
                    <input type="radio" id="mono" name="channels" value="mono">
                    <label for="mono">Mono</label><br>
                    <input type="radio" id="stereo" name="channels" value="stereo">
                    <label for="stereo">Stereo</label><br>
                </div>
                <div class="right-grid-1-item">
                    <p class="right-grid-1-item-label">Choose B-format type:</p>
                    <input type="radio" id="ambix" name="bformat" value="ambix" checked>
                    <label for="ambix">Ambix</label><br>
                    <input type="radio" id="fuma" name="bformat" value="fuma">
                    <label for="fuma">FuMa</label><br>
                </div>
            </div>
            <div id="mono-div" class="mono-div">
                <input type="range" min="-180" max="180" value="0" class="slider" id="theta">
                <label for="css">Theta</label><br>
                <input type="range" min="0" max="100" value="0.5" class="slider" id="polarity">
                <label for="css">Polarity</label><br>
                <input type="button" id="convert-mono" value="Convert" class="btn-big btn btn-info"/>
            </div>
            <div id="stereo-div" class="stereo-div">
                <p class="right-grid-1-item-label">Choose stereo method:</p>
                <input type="radio" id="XY" name="method" value="XY" checked>
                <label for="stereo">XY</label></br>
                <input type="radio" id="Blumlein" name="method" value="Blumlein">
                <label for="mono">Blumlein</label></br>                    
                <input type="radio" id="MS" name="method" value="MS">
                <label for="stereo">MS</label></br>     
                <input type="button" id="convert-stereo" value="Convert" class="btn-big btn btn-info"/>   
            </div>
        </div> 
    </div>
    <script>
        var serverAdress = "http://127.0.0.1:8000/";
        var filename = "";

        async function handleFiles(event) {
            let data = new FormData();
            var file = event.target.files[0];
            filename = file.name;
            data.append('file', file);
            const options = {
                method: 'POST',
                body: data,
            };

            await fetch(serverAdress + "savefile", options).then(response => response.json()).then(response => console.log(response));
            
        }

        function channels(event) {
            let isMono = document.getElementById("mono").checked;
            if (!isMono) {
                document.getElementById("mono-div").setAttribute('style', 'display: none');
                document.getElementById("stereo-div").setAttribute('style', 'display: block');
            }
            else {
                document.getElementById("mono-div").setAttribute('style', 'display: block');
                document.getElementById("stereo-div").setAttribute('style', 'display: none');
            }
        }

        async function convertMono(event) {

            if (filename === "") return;
            
            var elems = document.getElementsByName("bformat");
            var format = "";
            elems.forEach(x => {
                if (x.checked) format = x.value;
            });

            var theta = document.getElementById("theta").value;
            var polarity = document.getElementById("polarity").value

            const options = {
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                },
                method: 'POST',
                body: JSON.stringify({
                    "filename": filename,
                    "theta": theta,
                    "p": polarity,
                    "format": format
                })
            };

            let response =  await fetch(serverAdress + "convertmono", options)
                                    .then(response => response.json())
                                    .then(response => console.log(response));

        }

        async function convertStereo(event) {
            if (filename === "") return;

            var elems = document.getElementsByName("bformat");
            var format = "";
            elems.forEach(x => {
                if (x.checked) format = x.value;
            });

            var elems = document.getElementsByName("method");
            var method = "";
            elems.forEach(x => {
                if (x.checked) method = x.value;
            });
            const options = {
                headers: {
                    "Content-Type": "application/json; charset=utf-8"
                },
                method: 'POST',
                body: JSON.stringify({
                    "filename": filename,
                    "method": method,
                    "format": format
                })
            };

            let response =  await fetch(serverAdress + "convertstereo", options)
                                    .then(response => response.json())
                                    .then(response => console.log(response));
        }

        document.getElementById("upload").addEventListener("change", handleFiles, false);
        document.getElementById("mono").addEventListener("change", channels, false);
        document.getElementById("stereo").addEventListener("change", channels, false);
        document.getElementById("convert-mono").addEventListener("click", convertMono, false);
        document.getElementById("convert-stereo").addEventListener("click", convertStereo, false);
    </script>
</body>
</html> 